---
name: Build and Sign EMailCountrySorter

'on':
  push:
    tags: ['v*', 'release-*']
  workflow_dispatch:

jobs:
  build-sign:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Build EXE with PyInstaller
        shell: pwsh
        run: |
          $args = @(
            '-m', 'PyInstaller',
            '--onefile',
            '--name', 'EMailCountrySorter',
            '--add-data', 'Tld.map;.',
            '--add-data', 'Setting.ini;.',
            '--add-data', 'Country.mmdb;.'
          )
          if (Test-Path .\app.ico) {
            Write-Host 'Found app.ico'
            $args += @('--icon', '.\app.ico')
          } else {
            Write-Host 'No app.ico found'
          }
          $args += @('mail_country_sorter.py')
          & python @args

      - name: Prepare PFX (from secret)
        shell: pwsh
        env:
          PFX_BASE64: ${{ secrets.PFX_BASE64 }}
        run: |
          if (-not $env:PFX_BASE64) {
            Write-Host 'PFX_BASE64 secret missing'
            exit 0
          }
          try {
            $b = [System.Convert]::FromBase64String(
              $env:PFX_BASE64
            )
            [System.IO.File]::WriteAllBytes('cert.pfx', $b)
            Write-Host 'Wrote cert.pfx'
          } catch {
            Write-Warning "Failed: $_"
            exit 1
          }

      - name: Sign EXE
        shell: pwsh
        env:
          PFX_PASSWORD: ${{ secrets.PFX_PASSWORD }}
        run: |
          if (-not $env:PFX_PASSWORD) {
            Write-Host 'PFX_PASSWORD secret missing'
            exit 0
          }
          $exe = Join-Path $PWD 'dist\EMailCountrySorter.exe'
          if (-Not (Test-Path $exe)) {
            Write-Error "EXE not found: $exe"
            exit 1
          }
          if (-Not (Test-Path .\cert.pfx)) {
            Write-Host 'No PFX provided'
            exit 0
          }
          try {
            $st = (
              Get-Command signtool -ErrorAction SilentlyContinue
            ).Source
            if ($st) {
              Write-Host "Signing with signtool"
              $a = @(
                'sign', '/f', '.\cert.pfx',
                '/p', $env:PFX_PASSWORD,
                '/fd', 'SHA256',
                '/tr', 'https://timestamp.digicert.com',
                '/td', 'SHA256', $exe
              )
              & $st @a
            } else {
              Write-Host 'Using Set-AuthenticodeSignature'
              $cert = New-Object `
                System.Security.Cryptography.X509Certificates.X509Certificate2
              $bytes = [System.IO.File]::ReadAllBytes(
                '.\cert.pfx'
              )
              $cert.Import(
                $bytes, $env:PFX_PASSWORD,
                'Exportable,PersistKeySet'
              )
              $store = New-Object `
                System.Security.Cryptography.X509Certificates.X509Store(
                  'My','CurrentUser'
                )
              $store.Open('ReadWrite')
              $store.Add($cert)
              $store.Close()
              Set-AuthenticodeSignature `
                -FilePath $exe `
                -Certificate $cert `
                -HashAlgorithm 'SHA256'
            }
          } catch {
            Write-Warning "Signing failed: $_"
            exit 1
          }

      - name: Verify signature
        shell: pwsh
        run: |
          Get-AuthenticodeSignature `
            .\dist\EMailCountrySorter.exe | Format-List

      - name: Upload signed EXE
        uses: actions/upload-artifact@v4
        with:
          name: EMailCountrySorter-exe
          path: dist/EMailCountrySorter.exe
